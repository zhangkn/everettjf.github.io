<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>使用fastlane实现iOS持续集成</title>
	
	<meta name="description" content="">
	<meta name="image" content="favicon.ico">
	
	<meta itemprop="name" content="使用fastlane实现iOS持续集成">
	<meta itemprop="description" content="">
	<meta itemprop="image" content="favicon.ico">
	
	<meta name="twitter:card" content="summary">
	<meta name="twitter:title" content="使用fastlane实现iOS持续集成">
	<meta name="twitter:description" content="">
	<meta name="twitter:site" content="@everettjf">
	<meta name="twitter:creator" content="@everettjf">
	<meta name="twitter:image:src" content="favicon.ico">
	
	
	<meta name="og:title" content="使用fastlane实现iOS持续集成">
	<meta name="og:description" content="">
	<meta name="og:image" content="http://everettjf.com/favicon.ico">
	<meta name="og:url" content="http://everettjf.com/2015/09/08/%E4%BD%BF%E7%94%A8fastlane%E5%AE%9E%E7%8E%B0ios%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/">
	<meta name="og:site_name" content="使用fastlane实现iOS持续集成">
	<meta name="og:type" content="article">
	
	<meta name="article:author" content="everettjf">
	<meta name="article:tag" content="">
	<link rel="stylesheet" type="text/css" href="/css/style.css">
	<script src="/js/caption.js"></script>

	<link rel="icon" href="/favicon.ico" type="image/x-icon">  
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">  

	
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111349332-1"></script>
	<script>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());

	gtag('config', 'UA-111349332-1');
	</script>

</head>

<body>

<header>
	<a href="/">/posts</a>
	
		
		&nbsp;&nbsp;·&nbsp;<a href="/about/" style="color:black;">/about</a>
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	


</header>


<div id="loadingMask" style="width: 100%; height: 100%; position: fixed; background: #fff;"></div>
<script>
function fadeOut(el) {
  el.style.opacity = 1;

  var last = +new Date();
  var tick = function() {
    el.style.opacity = +el.style.opacity - (new Date() - last) / 80;
    last = +new Date();
    

    if (el.style.opacity > 0) {
      (window.requestAnimationFrame && requestAnimationFrame(tick)) || setTimeout(tick, 16);
    } else {
    	el.style.display='none';
    }
  };

  tick();
}

function ready(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
         el = document.getElementById('loadingMask');
         fadeOut(el);
        var elements = document.querySelectorAll("img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("alt")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("alt"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });

    } else {
        document.addEventListener('DOMContentLoaded', fn);
    }
}
window.onload = ready;
</script>

<div class="content">
    <h1>使用fastlane实现iOS持续集成 <aside></aside></h1>

    <p>
    <nav id="TableOfContents">
<ul>
<li><a href="#简介">简介</a></li>
<li><a href="#目标">目标</a></li>
<li><a href="#源代码">源代码</a></li>
<li><a href="#安装">安装</a></li>
<li><a href="#示例步骤">示例步骤</a></li>
<li><a href="#配置jenkins">配置Jenkins</a></li>
<li><a href="#苹果开发者证书配置">苹果开发者证书配置</a></li>
<li><a href="#相关文档">相关文档</a></li>
<li><a href="#其他途径">其他途径</a></li>
<li><a href="#重要补充">重要补充</a></li>
<li><a href="#2015年10月16日补充">2015年10月16日补充</a></li>
</ul>
</nav>
    </p>

    <hr/>
    <p>&nbsp;</p>

    

<h1 id="简介">简介</h1>

<p>持续集成是个“一次配置长期受益”的工作。但很多小公司都没有。以前在做Windows开发配置感觉简单一些，这次配置iOS的，感觉步骤还挺多。整理出来，分享给大家，不正确的地方请及时指正。</p>

<p>本文主要使用fastlane配置iOS的持续集成，自动编译、打包出多个版本。</p>

<p>最近转行iOS开发，首要任务是使用Jenkins（算是hudson的兄弟）配置iOS工程的持续集成。
查找各种资料后，整理出以下几个关键词。</p>

<ol>
<li>jenkins搭建。</li>
<li>使用fastlane中提供的工具修改工程配置。</li>
<li>gym 或 ipa 工具编译工程。</li>
</ol>

<h1 id="目标">目标</h1>

<ol>
<li><p>配置一台电脑自动获取代码，并定时打包出以下版本的ipa文件。</p>

<ul>
<li>内部测试版本：使用标准开发者的Developer证书签名的ipa文件。</li>
<li>公开测试版本：使用企业账户的Distribute InHouse证书签名的ipa文件。</li>
<li>AppStore版本：使用标准开发者的AppStore证书签名的ipa文件。</li>
<li>渠道版本：内部测试版本，但Info.plist中增加每个渠道的标示符<DEL>（因为渠道例如fir.im 会使用自己的证书重新签名ipa）</DEL>
PS: 2015年11月24日补充，fir.im 不会重新签名ipa。</li>
</ul></li>

<li><p>保留每个版本的dSYM调试符号文件。</p></li>
</ol>

<h1 id="源代码">源代码</h1>

<p><a href="https://github.com/everettjf/Yolo/tree/master/FastlaneBasicDemo4iOS">https://github.com/everettjf/Yolo/tree/master/FastlaneBasicDemo4iOS</a></p>

<h1 id="安装">安装</h1>

<p>fastlane和shenzhen都需要gem安装，把gem更换为<code>淘宝源</code>。</p>

<p>1- 安装fastlane</p>

<pre><code>sudo gem install fastlane
</code></pre>

<ul>
<li>fastlane是ruby编写，使用gem安装。</li>
<li><a href="https://fastlane.tools/">https://fastlane.tools/</a></li>
</ul>

<p>2- 安装shenzhen</p>

<pre><code>  sudo gem install shenzhen
</code></pre>

<ul>
<li>如果只使用了gym命令，而不使用ipa命令，可以不安装。</li>
<li><a href="https://github.com/nomad/shenzhen">https://github.com/nomad/shenzhen</a></li>
</ul>

<h1 id="示例步骤">示例步骤</h1>

<p>1- 在xcodeproj文件同级目录下，执行</p>

<pre><code>fastlane init
</code></pre>

<p>fastlane 很强大，甚至能自动截图，自动提交AppStore审核，不过我只用最简单的打包功能。
这里会有一系列提问。</p>

<pre><code>* Do you want to get started...? y
* Do you have everything commited... ? y
* App Identifier (com.krausefx.app): com.everettjf.fastlanedemo
* Your Apple ID (fastlane@krausefx.com): xxxxxxxx@xxxx.com
* ... updates to the App Store or Apple TestFlight? (y/n) n
* Do you want to setup 'snapshot'... n
* Do you want to use 'sigh'... n （是否自动下载provisioning文件）
* The scheme name of your app: fastlanetest （如果就一个工程，也可不输入）
</code></pre>

<p>上面有一步要输入AppleID，是因为fastlane（的一个工具sigh，这个字母是H）会自动下载对应的provisioning文件。自动下载provisioning文件，对于经常增加测试设备的Developer证书挺方便。不过，示例就不自动下载了。</p>

<p>执行完成后，会在工程目录下生成fastlane文件夹。</p>

<pre><code>drwxr-xr-x   5 everettjf  staff   170B Sep  8 22:32 fastlane
drwxr-xr-x  10 everettjf  staff   340B Sep  8 22:00 fastlanedemo
drwxr-xr-x   5 everettjf  staff   170B Sep  8 22:38 fastlanedemo.xcodeproj
drwxr-xr-x   4 everettjf  staff   136B Sep  8 22:00 fastlanedemoTests
</code></pre>

<p>我们需要修改fastlane文件夹的两个配置文件：Appfile和Fastfile。（实际是ruby代码）</p>

<p>2- 修改Appfile</p>

<pre><code class="language-ruby">app_identifier &quot;com.everettjf.fastlanedemo&quot;
apple_id &quot;aaa@aaa.com&quot;

for_lane :inhouse do
  app_identifier &quot;com.everettjf.fastlanedemoqiye&quot;
  apple_id &quot;bbb@bbb.com&quot;
end
</code></pre>

<p>企业InHouse版本与AppStore的app_identifier、apple_id不同。
  这里for_lane 就是为后面Fastfile中定义的:inhouse版本设置单独的信息。</p>

<p>3- 修改Fastfile</p>

<p>这个文件中要编写每个版本的编译和打包代码（Developer版本、AppStore版本、InHouse版本、多个渠道版本），
  每个版本要经过以下几个步骤：
  - 修改版本号和build号（修改为外部传入的版本，例如：1.0.0和100）
  -</p>

<pre><code class="language-ruby">def prepare_version(options)
    #say 'version number:'
    #say options[:version]
    increment_version_number(
        version_number: options[:version],
        xcodeproj: PROJECT_FILE_PATH,
    )
    #say 'build number:'
    #say options[:build]
    increment_build_number(
        build_number: options[:build],
        xcodeproj: PROJECT_FILE_PATH,
    )
end
</code></pre>

<ul>
<li>修改app identifier（就是bundle id，例如：com.everettjf.fastlanedemo）</li>
</ul>

<pre><code class="language-ruby">def update_app_identifier(app_id)
    update_info_plist(
        xcodeproj:PROJECT_FILE_PATH ,
        app_identifier:app_id,
        plist_path:&quot;#{PLIST_FILE_PATH}&quot;
    )
    update_info_plist(
        xcodeproj:PROJECT_FILE_PATH ,
        app_identifier:app_id,
        plist_path:&quot;#{UNITTEST_PLIST_FILE_PATH}&quot;
    )
end
</code></pre>

<ul>
<li>修改签名的配置，配置对应的provision file</li>
</ul>

<pre><code class="language-ruby">def update_provision(typePrefix)
  update_project_provisioning(
      xcodeproj:PROJECT_FILE_PATH ,
      profile:&quot;./fastlane/provision/#{typePrefix}.mobileprovision&quot;,
  )
end
</code></pre>

<ul>
<li>渠道版本修改Info.plist文件中对应的字符串</li>
</ul>

<pre><code class="language-ruby">def set_info_plist_value(path,key,value)
  sh &quot;/usr/libexec/PlistBuddy -c \&quot;set :#{key} #{value}\&quot; #{path}&quot;
end
def set_channel_id(channelId)
    set_info_plist_value(
        &quot;./../fastlanedemo/#{PLIST_FILE_PATH}&quot;,
        'ChannelID',
        &quot;#{channelId}&quot;
    )
end
</code></pre>

<ul>
<li>编译打包为ipa</li>
</ul>

<p>这步使用了工具shenzhen，也可以使用fastlane推荐的gym。</p>

<pre><code class="language-ruby">def generate_ipa(typePrefix,options)
  #say 'generate ipa'
  fullVersion = options[:version] + '.' + options[:build]
  channelId = options[:channel_id]
  ipa(
      configuration:&quot;Release&quot;,
      scheme:&quot;#{SCHEME_NAME}&quot;,
      destination:&quot;./build&quot;,
      ipa:&quot;#{APP_NAME}_#{fullVersion}_#{typePrefix}.ipa&quot;,
      archive:false
  )
  sh &quot;mv ./../build/#{APP_NAME}.app.dSYM.zip ./../build/#{APP_NAME}_#{fullVersion}_#{typePrefix}.app.dSYM.zip&quot;
end
</code></pre>

<p>4- 编写shell脚本</p>

<pre><code>#!/bin/sh

#
# usage:
# &gt; sh build.sh 1.0.0 200
#

versionNumber=$1 # 1.0.0
buildNumber=$2 # 2000

rm -rf build

basicLanes=&quot;AdHoc AppStore Develop InHouse&quot;
for laneName in $basicLanes
do
    fastlane $laneName version:$versionNumber build:$buildNumber
done

channelIds=&quot;fir 91&quot;
for channelId in $channelIds
do
    fastlane Channel version:$versionNumber build:$buildNumber channel_id:$channelId
done
</code></pre>

<pre><code>sh build.sh 1.0.0 100
</code></pre>

<p>我们传入主版本号和一个自增的id（一般是jenkins的build number）。</p>

<h1 id="配置jenkins">配置Jenkins</h1>

<p>有了能一键编译的脚本，让Jenkins在获取代码后，调用build.sh就可以了。</p>

<p>安装</p>

<pre><code>brew install jenkins
</code></pre>

<p>配置获取代码，获取代码后调用shell：</p>

<pre><code>sh build.sh 1.0.0 ${BUILD_NUMBER}
</code></pre>

<h1 id="苹果开发者证书配置">苹果开发者证书配置</h1>

<p>假设我们有两个开发者账号，一个是标准开发者账户（99刀，个人或公司），一个是企业账户（299刀）。
- 标准开发者账户：aaa@aaa.com</p>

<pre><code>Identifier中增加com.everettjf.fastlanedemo
Provisioning Profiles中增加一个 iOS Distribution(AdHoc 和 AppStore) 和 iOS Development
</code></pre>

<ul>
<li>企业账户：bbb@bbb.com</li>
</ul>

<pre><code>Identifier中增加com.everettjf.fastlanedemoqiye
Provisioning Profiles中增加一个 iOS Distribution(AdInHouse)
</code></pre>

<h1 id="相关文档">相关文档</h1>

<ul>
<li>fastlane：<a href="https://github.com/KrauseFx/fastlane/tree/master/docs">https://github.com/KrauseFx/fastlane/tree/master/docs</a></li>
<li>shenzhen : <a href="https://github.com/nomad/shenzhen">https://github.com/nomad/shenzhen</a></li>
</ul>

<h1 id="其他途径">其他途径</h1>

<ol>
<li>Jenkins的xcode插件：Jenkins有个xcode插件，网上有些文章，不过自己没有使用。不知道能否
动态的更换证书。</li>
<li>一次编译多次签名：在没有使用fastlane之前，看到fastlane提供了一套工具集，就使用gym先编译
一个Developer证书签名的ipa，之后使用其他证书分别签名。</li>
</ol>

<h1 id="重要补充">重要补充</h1>

<ul>
<li>安装jenkins的机器上的Xcode要导入开发者账户（存在私钥的账户信息，通过首次创建证书的电脑上的Xcode导出）</li>
</ul>

<h1 id="2015年10月16日补充">2015年10月16日补充</h1>

<p>事件：Xcode7发布后</p>

<p>CFBundleIdentifier 建议使用 $(PRODUCT_BUNDLE_IDENTIFIER) 代替原有的 $(BUNDLE_IDENTIFIER). Info.plist文件中的$(BUNDLE_IDENTIFIER)也会自动指向$(PRODUCT_BUNDLE_IDENTIFIER)。</p>

<p>因此，fastlane提供的action <code>update_info_list</code> 无法更新project文件中的$(PRODUCT_BUNDLE_IDENTIFIER) 。
也就导致在打包企业版本时原有脚本不能修改位于新位置的bundle identifier，目前临时解决办法：</p>

<pre><code>sh &quot;sed -i '' 's/com.xxx.xxx/com.xxx.yyy/g' path/project.pbxproj&quot;
</code></pre>

<p>为此给fast lane提了一个issue : <a href="https://github.com/KrauseFx/fastlane/issues/684">https://github.com/KrauseFx/fastlane/issues/684</a></p>

<p>fastlane很快会提供更新的方式。
感谢fastlane的开发者squarefrog和KrauseFx。</p>


    
</div>



	<p><small><em>Written September 8, 2015. </em>
		 
		Send feedback to <a  href="https://twitter.com/intent/tweet?text=%40everettjf%20%2320150908%25E4%25BD%25BF%25E7%2594%25A8fastlane%25E5%25AE%259E%25E7%258E%25B0ios%25E6%258C%2581%25E7%25BB%25AD%25E9%259B%2586%25E6%2588%2590%20">@everettjf</a>.
		
    </small></p>

	<p>
	<a href="/2015/08/13/%E5%8C%97%E4%BA%AC%E6%88%91%E6%9D%A5%E4%BA%86%E5%BC%80%E5%BF%83%E7%9A%84%E5%A5%8B%E6%96%97%E5%90%A7/">← 北京，我来了，开心的奋斗吧</a>&nbsp;
	<a href="/2015/09/09/ios%E5%B4%A9%E6%BA%83%E6%94%B6%E9%9B%86%E4%B8%8E%E5%88%86%E6%9E%90%E4%BD%BF%E7%94%A8plcrashreporter/" style="float:right;">iOS崩溃收集与分析，使用PLCrashReporter →</a>
	</p>



<section id="disqus_thread"></section>


<script type="text/javascript">
     
    var disqus_shortname = 'everettjf';

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

     
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



<footer>
	<hr/>
	<p>https://creativecommons.org/licenses/by-nc-sa/2.5/</p>
	<p>This site was made with <a href="https://github.com/gohugoio/hugo">Hugo</a> using theme <a href="https://github.com/schollz/onetwothree">onetwothree</a>.</p>
</footer>
</body>
</html>
