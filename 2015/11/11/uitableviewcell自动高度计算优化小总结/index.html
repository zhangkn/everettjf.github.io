<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>UITableViewCell自动高度计算优化小总结</title>
	
	<meta name="description" content="">
	<meta name="image" content="favicon.ico">
	
	<meta itemprop="name" content="UITableViewCell自动高度计算优化小总结">
	<meta itemprop="description" content="">
	<meta itemprop="image" content="favicon.ico">
	
	<meta name="twitter:card" content="summary">
	<meta name="twitter:title" content="UITableViewCell自动高度计算优化小总结">
	<meta name="twitter:description" content="">
	<meta name="twitter:site" content="@everettjf">
	<meta name="twitter:creator" content="@everettjf">
	<meta name="twitter:image:src" content="favicon.ico">
	
	
	<meta name="og:title" content="UITableViewCell自动高度计算优化小总结">
	<meta name="og:description" content="">
	<meta name="og:image" content="http://everettjf.com/favicon.ico">
	<meta name="og:url" content="http://everettjf.com/2015/11/11/uitableviewcell%E8%87%AA%E5%8A%A8%E9%AB%98%E5%BA%A6%E8%AE%A1%E7%AE%97%E4%BC%98%E5%8C%96%E5%B0%8F%E6%80%BB%E7%BB%93/">
	<meta name="og:site_name" content="UITableViewCell自动高度计算优化小总结">
	<meta name="og:type" content="article">
	
	<meta name="article:author" content="everettjf">
	<meta name="article:tag" content="">
	<link rel="stylesheet" type="text/css" href="/css/style.css">
	<script src="/js/caption.js"></script>

	<link rel="icon" href="/favicon.ico" type="image/x-icon">  
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">  

	
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111349332-1"></script>
	<script>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());

	gtag('config', 'UA-111349332-1');
	</script>

</head>

<body>

<header>
	<a href="/">/posts</a>
	
		
		&nbsp;&nbsp;·&nbsp;<a href="/about/" style="color:black;">/about</a>
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	


</header>


<div class="content">
    <h1>UITableViewCell自动高度计算优化小总结 <aside></aside></h1>

    <p>
    <nav id="TableOfContents">
<ul>
<li><a href="#背景">背景</a></li>
<li><a href="#要求">要求</a></li>
<li><a href="#功能实现">功能实现</a>
<ul>
<li><a href="#自动计算高度">自动计算高度</a></li>
<li><a href="#高度计算占用cpu的原因">高度计算占用CPU的原因</a></li>
</ul></li>
<li><a href="#使用estimated效果不好">使用estimated效果不好</a></li>
<li><a href="#使用缓存">使用缓存</a></li>
<li><a href="#自动滚动">自动滚动</a></li>
<li><a href="#参考文章">参考文章</a></li>
</ul>
</nav>
    </p>

    <hr/>
    <p>&nbsp;</p>

    

<h1 id="背景">背景</h1>

<ul>
<li>一个主播聊天室，大量观众能发送大量的消息，赠送一些道具也会导致产生大量的道具消息。这里假设消息很多的情况：<code>每秒5条消息到来</code>。</li>
<li>消息使用NSAttributedString实现，<code>消息中包含不同大小的图片和文字</code>。</li>
<li>消息到来后，<code>自动滚动到最后一条消息</code>。</li>
<li>全局消息列表（存储最近500条消息，到达500条后直接删除最早的300条）</li>
</ul>

<h1 id="要求">要求</h1>

<ul>
<li>不能占用大量CPU。</li>
<li>在大量消息到来的情况下，界面不能卡顿。</li>
</ul>

<h1 id="功能实现">功能实现</h1>

<h2 id="自动计算高度">自动计算高度</h2>

<p>使用一个不错的开源库
<a href="https://github.com/forkingdog/UITableView-FDTemplateLayoutCell">UITableView-FDTemplateLayoutCell</a></p>

<p>这个开源库在数据较少时没有问题，但当数据（消息）不断增加时，会导致高度计算量大增。</p>

<h2 id="高度计算占用cpu的原因">高度计算占用CPU的原因</h2>

<p>自动布局的高度计算速度慢。这个函数：<code>systemLayoutSizeFittingSize</code>计算慢。</p>

<h1 id="使用estimated效果不好">使用estimated效果不好</h1>

<pre><code>- (CGFloat)tableView:(UITableView * _Nonnull)tableView estimatedHeightForRowAtIndexPath:(NSIndexPath * _Nonnull)indexPath

</code></pre>

<p>估计高度，会减少很多高度的计算量，每当Cell需要显示的时候才会计算高度。但大量消息的到来会导致Cell抖动，看起来很不舒服。</p>

<p>因为新增Cell是先按照估计高度显示，如果实际所需高度与估计高度不同，会在Cell显示后，再有个调整高度的过程（会有个简单的动画效果。这个效果如果在新增一条消息时很不多，但如果大量消息很短的间隔到来，就会导致Cell跳动起来）</p>

<h1 id="使用缓存">使用缓存</h1>

<p>不能使用IndexPath缓存：如果使用IndexPath缓存，则当消息到达500条，删除最早300条时，会导致所有Cell都需要重新计算高度。然而，剩余的那200条消息是已经计算过的。</p>

<p>由于消息一旦产生就不会变化，可将计算后的Cell高度再一次缓存到消息中。</p>

<pre><code class="language-c">-(CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    NSInteger row = [indexPath row];
    MessageEntity *msg = self.data[row];
    if(msg.heightCache &gt; 0){
   		//当缓存有缓存的高度时，直接返回对应的高度
        return msg.heightCache;
    }

    CGFloat height = [tableView fd_heightForCellWithIdentifier:@&quot;Cell&quot; cacheByIndexPath:indexPath configuration:^(id obj) {
        MessageTableViewCell *cell = obj;
		 // Fill Cell
    }];

    msg.heightCache = height;
    return height;
}
</code></pre>

<p>或者，如果消息有一个唯一id，可以使用id缓存。</p>

<pre><code class="language-c">- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath {
    Entity *entity = self.entities[indexPath.row];
    return [tableView fd_heightForCellWithIdentifier:@&quot;identifer&quot; cacheByKey:entity.uid configuration:^(id cell) {
        // configurations
    }];
}
</code></pre>

<h1 id="自动滚动">自动滚动</h1>

<p>由于消息产生速度过快，比滚动到最后一行的速度还快。因此，增加个延迟。并过滤到延迟到来之前的滚动请求。</p>

<h1 id="参考文章">参考文章</h1>

<p><a href="http://blog.sunnyxx.com/2015/05/17/cell-height-calculation/">http://blog.sunnyxx.com/2015/05/17/cell-height-calculation/</a></p>


    
</div>



	<p><small><em>Written November 11, 2015. </em>
		 
		Send feedback to <a  href="https://twitter.com/intent/tweet?text=%40everettjf%20%2320151111uitableviewcell%25E8%2587%25AA%25E5%258A%25A8%25E9%25AB%2598%25E5%25BA%25A6%25E8%25AE%25A1%25E7%25AE%2597%25E4%25BC%2598%25E5%258C%2596%25E5%25B0%258F%25E6%2580%25BB%25E7%25BB%2593%20">@everettjf</a>.
		
    </small></p>

	<p>
	<a href="/2015/11/01/%E5%8F%82%E4%B8%8Esegmentfault-hackathon-2015-%E5%8C%97%E4%BA%AC%E7%AB%99-%E6%80%BB%E7%BB%93/">← 参与SegmentFault Hackathon 2015 北京站 总结</a>&nbsp;
	<a href="/2015/11/18/summary-for-c---transfer-to-ios-develop-for-the-past-5-months/" style="float:right;">Summary for C&#43;&#43; transfer to iOS develop for the past 5 months →</a>
	</p>



<section id="disqus_thread"></section>


<script type="text/javascript">
     
    var disqus_shortname = 'everettjf';

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

     
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



<footer>
	<hr/>
	<p>https://creativecommons.org/licenses/by-nc-sa/2.5/</p>
	<p>This site was made with <a href="https://github.com/gohugoio/hugo">Hugo</a> using theme <a href="https://github.com/schollz/onetwothree">onetwothree</a>.</p>
</footer>
</body>
</html>
