<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>如何编写简易病毒扫描程序</title>
	
	<meta name="description" content="">
	<meta name="image" content="favicon.ico">
	
	<meta itemprop="name" content="如何编写简易病毒扫描程序">
	<meta itemprop="description" content="">
	<meta itemprop="image" content="favicon.ico">
	
	<meta name="twitter:card" content="summary">
	<meta name="twitter:title" content="如何编写简易病毒扫描程序">
	<meta name="twitter:description" content="">
	<meta name="twitter:site" content="@everettjf">
	<meta name="twitter:creator" content="@everettjf">
	<meta name="twitter:image:src" content="favicon.ico">
	
	
	<meta name="og:title" content="如何编写简易病毒扫描程序">
	<meta name="og:description" content="">
	<meta name="og:image" content="http://everettjf.com/favicon.ico">
	<meta name="og:url" content="http://everettjf.com/2014/12/07/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%E7%AE%80%E6%98%93%E7%97%85%E6%AF%92%E6%89%AB%E6%8F%8F%E7%A8%8B%E5%BA%8F/">
	<meta name="og:site_name" content="如何编写简易病毒扫描程序">
	<meta name="og:type" content="article">
	
	<meta name="article:author" content="everettjf">
	<meta name="article:tag" content="">
	<link rel="stylesheet" type="text/css" href="/css/style.css">
	<script src="/js/caption.js"></script>

	<link rel="icon" href="/favicon.ico" type="image/x-icon">  
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">  

	
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111349332-1"></script>
	<script>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());

	gtag('config', 'UA-111349332-1');
	</script>

</head>

<body>

<header>
	<a href="/">/posts</a>
	
		
		&nbsp;&nbsp;·&nbsp;<a href="/about/" style="color:black;">/about</a>
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	


</header>


<div id="loadingMask" style="width: 100%; height: 100%; position: fixed; background: #fff;"></div>
<script>
function fadeOut(el) {
  el.style.opacity = 1;

  var last = +new Date();
  var tick = function() {
    el.style.opacity = +el.style.opacity - (new Date() - last) / 80;
    last = +new Date();
    

    if (el.style.opacity > 0) {
      (window.requestAnimationFrame && requestAnimationFrame(tick)) || setTimeout(tick, 16);
    } else {
    	el.style.display='none';
    }
  };

  tick();
}

function ready(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
         el = document.getElementById('loadingMask');
         fadeOut(el);
        var elements = document.querySelectorAll("img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("alt")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("alt"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });

    } else {
        document.addEventListener('DOMContentLoaded', fn);
    }
}
window.onload = ready;
</script>

<div class="content">
    <h1>如何编写简易病毒扫描程序 <aside></aside></h1>

    <p>
    <nav id="TableOfContents">
<ul>
<li><a href="#背景">背景</a></li>
<li><a href="#面向读者">面向读者</a></li>
<li><a href="#主要内容">主要内容</a></li>
<li><a href="#什么是计算机病毒">什么是计算机病毒</a>
<ul>
<li>
<ul>
<li><a href="#计算机病毒的定义">计算机病毒的定义</a></li>
<li><a href="#第一个计算机病毒">第一个计算机病毒</a></li>
<li><a href="#病毒的主要特征">病毒的主要特征</a></li>
<li><a href="#病毒的分类">病毒的分类</a></li>
<li><a href="#病毒的危害">病毒的危害</a></li>
</ul></li>
</ul></li>
<li><a href="#反病毒技术的发展">反病毒技术的发展</a>
<ul>
<li>
<ul>
<li><a href="#反病毒软件的组成">反病毒软件的组成</a></li>
<li><a href="#基于文件的第一代扫描技术">基于文件的第一代扫描技术</a></li>
<li><a href="#基于文件的第二代扫描技术">基于文件的第二代扫描技术</a></li>
<li><a href="#基于内存">基于内存</a></li>
<li><a href="#基于行为">基于行为</a></li>
<li><a href="#云查杀">云查杀</a></li>
<li><a href="#多引擎">多引擎</a></li>
<li><a href="#人工智能">人工智能</a></li>
</ul></li>
</ul></li>
<li><a href="#分析计算机病毒">分析计算机病毒</a>
<ul>
<li>
<ul>
<li><a href="#pe文件">PE文件</a></li>
<li><a href="#基本概念">基本概念</a></li>
<li><a href="#加壳">加壳</a></li>
<li><a href="#在线自动分析工具">在线自动分析工具</a></li>
<li><a href="#静态分析">静态分析</a></li>
<li><a href="#动态分析">动态分析</a></li>
<li><a href="#其他">其他</a></li>
</ul></li>
</ul></li>
<li><a href="#编写简易病毒扫描程序">编写简易病毒扫描程序</a>
<ul>
<li>
<ul>
<li><a href="#目标">目标</a></li>
<li><a href="#基于特征-feature-based">基于特征（feature-based）</a></li>
<li><a href="#思想">思想</a></li>
<li><a href="#机器学习">机器学习</a></li>
<li><a href="#获取病毒样本">获取病毒样本</a></li>
<li><a href="#开始开发">开始开发</a></li>
<li><a href="#pedump获取文件属性">pedump获取文件属性</a></li>
<li><a href="#将文件属性转换为向量-vector">将文件属性转换为向量（vector）</a></li>
<li><a href="#训练模型">训练模型</a></li>
<li><a href="#测试模型">测试模型</a></li>
<li><a href="#剩余问题">剩余问题</a></li>
<li><a href="#源码">源码</a></li>
<li><a href="#以上想法的来源">以上想法的来源</a></li>
<li><a href="#相关书籍">相关书籍</a></li>
<li><a href="#资料下载">资料下载</a></li>
<li><a href="#个人总结">个人总结</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </p>

    <hr/>
    <p>&nbsp;</p>

    

<h1 id="背景">背景</h1>

<ul>
<li>2014年12月7日，开源中国济南城市圈活动<a href="http://city.oschina.net/jinan/event/194933">技术分享</a></li>
<li>第一次公开场合技术分享</li>
<li>将此次分享的内容整理成简单的教程</li>
</ul>

<h1 id="面向读者">面向读者</h1>

<ul>
<li>对病毒分析感兴趣的新手</li>
</ul>

<h1 id="主要内容">主要内容</h1>

<ul>
<li>什么是计算机病毒</li>
<li>反病毒技术的发展</li>
<li>分析计算机病毒</li>
<li>编写简易的病毒扫描程序</li>
</ul>

<h1 id="什么是计算机病毒">什么是计算机病毒</h1>

<h3 id="计算机病毒的定义">计算机病毒的定义</h3>

<ol>
<li>1949年，冯诺依曼在论文《Theory of self-reproducing automata》中就第一次给出了病毒的定义：
<code>“能够实际复制自身的自动机”。</code></li>
<li>wikipedia：计算机病毒是一种在*人为或非人为*的情况下产生的、在*用户不知情或未批准*下，能*自我复制或运行*的电脑程序。
<a href="https://en.wikipedia.org/wiki/Computer_virus">参考</a></li>
</ol>

<h3 id="第一个计算机病毒">第一个计算机病毒</h3>

<ol>
<li><p>19世纪60年代，贝尔实验室3个人，在磁芯存储器上实现了2个程序，这2个程序想办法复制自身并让杀掉对方的程序，称为“磁芯大战”的游戏。</p></li>

<li><p>公认的第一个病毒1971年诞生，叫做Creeper的程序。
<a href="https://en.wikipedia.org/wiki/Creeper_(program)">参考</a>.</p></li>

<li><p>Reaper是用来清除掉Creeper的类似病毒的程序。</p></li>
</ol>

<h3 id="病毒的主要特征">病毒的主要特征</h3>

<ol>
<li>传播性</li>
<li>隐蔽性</li>
<li>感染性</li>
<li>潜伏性</li>
<li>可激发性</li>
<li>表现性</li>
<li>破坏性</li>
<li>变异性</li>
</ol>

<h3 id="病毒的分类">病毒的分类</h3>

<ol>
<li>木马、僵尸网络（僵尸或称肉鸡，DDOS）</li>
<li>有害软件（蠕虫、间谍软件、流氓软件、恶作剧软件）</li>
<li>脚本病毒（宏病毒）</li>
<li>文件型病毒（感染文件，寄宿在可执行文件等）</li>
</ol>

<p>此外，也可以参考开源杀毒软件<a href="http://www.clamav.net/">ClamAntiVirus</a>的病毒特征的分类，如图：</p>

<p><img src="/stuff/2014/clamav_signature.png" alt="alt text" title="ClamAV Signature" /></p>

<p>当然，以上分类并不严格，也没有一个分类标准。我认为，可以统称为*“恶意程序”*。</p>

<h3 id="病毒的危害">病毒的危害</h3>

<ol>
<li>冲击波蠕虫

<ul>
<li>2003年8月</li>
<li>DDOS攻击windowsupdate.com</li>
<li>利用系统rpc漏洞，自动传播</li>
<li>造成系统重启、崩溃</li>
<li>后期产生很多变种</li>
</ul></li>
</ol>

<p><code>病毒作者很有意思，把自己的名字Parson也写到病毒中了，于是就被抓了。</code></p>

<ol>
<li><p>恶作剧病毒</p>

<ul>
<li>女鬼病毒</li>
<li>2000年</li>
<li>台湾地区发作时，曾经使人因为惊吓过度送往医院救治后身亡</li>
</ul></li>

<li><p>火焰、震网、毒区</p>

<ul>
<li>国家安全级别</li>
<li>火焰的目标位伊朗石油部门商业情报，可追朔到2007年，2012年才被卡巴斯基发现。程序很大。</li>
<li>震网的目标是伊朗核设施</li>
<li>毒区的目标是伊朗工业控制数据</li>
<li>据说伊朗某个火箭发射基地出现的一次爆炸就是病毒所致，只不过官方不承认。</li>
<li><a href="http://bbs.pcbeta.com/forum.php?mod=viewthread&amp;tid=1052240">参考</a></li>
</ul></li>
</ol>

<h1 id="反病毒技术的发展">反病毒技术的发展</h1>

<h3 id="反病毒软件的组成">反病毒软件的组成</h3>

<ul>
<li>扫描器</li>
<li>病毒库</li>
<li>虚拟机（主要目的脱壳）</li>
</ul>

<h3 id="基于文件的第一代扫描技术">基于文件的第一代扫描技术</h3>

<ul>
<li>字符串扫描技术</li>
<li>通配符扫描技术</li>
</ul>

<h3 id="基于文件的第二代扫描技术">基于文件的第二代扫描技术</h3>

<ol>
<li>智能扫描法</li>
<li>近似精确匹配法

<ul>
<li>多套特征</li>
<li>校验和，分块校验，密码校验等</li>
</ul></li>
<li>骨架扫描法</li>
<li>精确识别法</li>
</ol>

<blockquote>
<p>ClamAV Hash-based &amp; Body-based</p>
</blockquote>

<h3 id="基于内存">基于内存</h3>

<ol>
<li>内存特征

<ul>
<li>为了应对加壳程序</li>
</ul></li>
</ol>

<h3 id="基于行为">基于行为</h3>

<ol>
<li>行为特征

<ul>
<li>例如：“一个程序将自己复制到system32目录下，然后自启动，最后删除自己&rdquo;，这个行为就是个可疑行为。</li>
</ul></li>
<li>主动防御

<ul>
<li>微点</li>
<li>360安全卫士</li>
</ul></li>
</ol>

<h3 id="云查杀">云查杀</h3>

<ol>
<li>利用服务器能力</li>
<li>大量客户端上报可疑文件</li>
</ol>

<h3 id="多引擎">多引擎</h3>

<ul>
<li>360的QVM、云引擎、小红伞、BitDefender</li>
</ul>

<blockquote>
<p>这个只是业务的组合，并没有实质性的改变。</p>
</blockquote>

<h3 id="人工智能">人工智能</h3>

<ul>
<li>机器学习、神经网络等</li>
<li>360QVM(Qihoo Support Vector Machine)</li>
<li>海量的白名单及病毒样本</li>
<li><a href="http://www.sumobrain.com/patents/wipo/Method-system-program-identification-based/WO2012071989.html">专利链接</a></li>
</ul>

<h1 id="分析计算机病毒">分析计算机病毒</h1>

<h3 id="pe文件">PE文件</h3>

<ul>
<li>可移植的可执行文件</li>
<li>Portable Executable</li>
<li>PE由Unix中的Common Object File Format（COFF）格式修改而来</li>
</ul>

<p><img src="/stuff/2014/pe.png" alt="alt text" title="pe" /></p>

<blockquote>
<ul>
<li>Windows  PE</li>
<li>Linux  ELF</li>
<li>MacOS  Mach-O</li>
</ul>
</blockquote>

<h3 id="基本概念">基本概念</h3>

<ol>
<li>IMAGE_DOS_HEADER

<ul>
<li>MZ</li>
<li>MS-DOS最初的架构师Mark Zbikowski</li>
</ul></li>
<li>导入表 Import Address Table</li>
<li>导出表</li>
<li>程序入口点

<ul>
<li>IMAGE_NT_HEADERS</li>
</ul></li>
<li>节

<ul>
<li>IMAGE_SECTION_HEADERS</li>
</ul></li>
<li>&hellip;</li>
</ol>

<blockquote>
<p>参考 winnt.h</p>
</blockquote>

<h3 id="加壳">加壳</h3>

<ul>
<li>可执行程序资源压缩</li>
<li>本意为保护文件</li>
<li>特殊的算法</li>
<li>在内存中解压</li>
<li>例如：UPX壳</li>
</ul>

<h3 id="在线自动分析工具">在线自动分析工具</h3>

<ul>
<li><a href="https://fireeye.ijinshan.com/">金山火眼</a></li>
<li><a href="http://www.virscan.org/">VirusScan</a></li>
</ul>

<h3 id="静态分析">静态分析</h3>

<p>IDA Pro
PEView
PEiD
Sysinternals - string , autorun …
Dependency Walker
…</p>

<h3 id="动态分析">动态分析</h3>

<p>OllyDbg
Windbg
WireShark
…</p>

<h3 id="其他">其他</h3>

<ul>
<li><a href="http://www.pediy.com/">看雪学院</a></li>
<li><a href="http://pan.baidu.com/s/1mgEduGC">工具分享</a></li>
</ul>

<h1 id="编写简易病毒扫描程序">编写简易病毒扫描程序</h1>

<h3 id="目标">目标</h3>

<ul>
<li>简易</li>
<li>扫描</li>
<li>基于文件</li>
</ul>

<h3 id="基于特征-feature-based">基于特征（feature-based）</h3>

<ol>
<li>File Size</li>
<li>Import Address Table(IAT)</li>
<li>Section</li>
<li>Resource (Version, Company)</li>
<li>Packer</li>
</ol>

<h3 id="思想">思想</h3>

<p>如果把“PE文件与操作系统”的关系，比作“人与世界”的关系。</p>

<ol>
<li>导入函数的类比

<ul>
<li>导入函数中包含CreateFile可以看做一个人拿着一支笔，人对世界没有什么危害。</li>
<li>导入函数CreateService就像人拿着一把小刀，对世界有了一点危害，但也不是那么大。</li>
<li>导入函数SetWindowsHook或CreateRemoteThread就像人拿着一把枪了，对世界危害就大了。</li>
</ul></li>
<li>节的类比

<ul>
<li>.text .rdata .data .rsrc .reloc就像一个穿着正常的好人。
<img src="/stuff/2014/goodman.png" alt="alt text" title="good man" /></li>
<li>.upx .upx1 就像是一个坏人了。
<img src="/stuff/2014/badman.png" alt="alt text" title="bad man" /></li>
</ul></li>
</ol>

<h3 id="机器学习">机器学习</h3>

<ul>
<li>SVM - Support Vector Machine 支持向量机</li>
<li>监督学习算法</li>
<li>libsvm</li>
<li>svm-toy.exe 简单实用</li>
</ul>

<h3 id="获取病毒样本">获取病毒样本</h3>

<p><a href="http://www.virussign.com/">virussign</a></p>

<p>卡饭或吾爱破解上也都提供了很多样本。</p>

<h3 id="开始开发">开始开发</h3>

<ol>
<li>开发语言 Ruby</li>
<li>基于三个库 rb-libsvm , pedump , sqlite3
可以通过下面这样安装</li>
</ol>

<pre><code>  &gt; gem install rb-libsvm
  &gt; gem intall pedump
  &gt; gem install sqlite3
</code></pre>

<h3 id="pedump获取文件属性">pedump获取文件属性</h3>

<ol>
<li>imports : string list</li>
<li>sections : string list</li>
<li>packer : string</li>
<li>version : string</li>
<li>company : string</li>
</ol>

<h3 id="将文件属性转换为向量-vector">将文件属性转换为向量（vector）</h3>

<ol>
<li><p>将packer转换为vector
有packer为1，否则为0</p></li>

<li><p>version和company同上。</p></li>

<li><p>将导入函数（imports）和节（sections）转换为向量（vector）</p></li>
</ol>

<pre><code>&gt; 可以这样，
&gt; 首先获取一个干净无毒的系统的system32下的所有文件的导入函数集合set(A)
&gt; 再获取一堆病毒（例如从virussign上获取到的病毒）的所有导入函数集合set(B)
&gt; set(C) = set(A) &amp; set(B)
&gt; set(D) = set(A) - set(B)
&gt; set(E) = set(B) - set(A)
&gt; 这样，set(C)set(D)set(E)给予不同的权值。
</code></pre>

<ol>
<li>最后将所有属性按照顺序组合成一个PE文件的vector</li>
</ol>

<ul>
<li>可以通过下面的命令获取到存储imports和sections的数据库。</li>
</ul>

<pre><code>ruby rvsfetchiat.rb --health C:/Windows/System32
ruby rvsfetchiat.rb --virus E:/train_virus/files
ruby rvsfetchiat.rb --merge
</code></pre>

<ul>
<li>通过下面的命令获取一个文件的属性</li>
</ul>

<pre><code>ruby rvsfetchiat.rb --file C:/Windows/System32/notepad.exe
</code></pre>

<h3 id="训练模型">训练模型</h3>

<p>指定存储要训练的正常文件的文件夹和病毒文件的文件夹。</p>

<pre><code>ruby rvsscan.rb --train /Users/everettjf/Virus/train/train_health /Users/everettjf/Virus/train/train_virus
</code></pre>

<h3 id="测试模型">测试模型</h3>

<pre><code>ruby rvsscan.rb --scan /Users/everettjf/Virus/train/train_virus
ruby rvsscan.rb --scan /Users/everettjf/Virus/train/train_health
ruby rvsscan.rb --scan /Users/everettjf/Virus/train/test_virus
ruby rvsscan.rb --scan /Users/everettjf/Virus/train/test_health
</code></pre>

<h3 id="剩余问题">剩余问题</h3>

<ul>
<li>训练大量的样本</li>
<li>调整参数，降低误报率</li>
<li>加入更多关键的特征，例如OEP是否被修改。</li>
<li>自学习</li>
</ul>

<h3 id="源码">源码</h3>

<p><a href="https://github.com/everettjf/RubySVMVirusScanner">source in github</a></p>

<h3 id="以上想法的来源">以上想法的来源</h3>

<p>QVM -&gt; xiao70 -&gt; me(everettjf)</p>

<h3 id="相关书籍">相关书籍</h3>

<ul>
<li>《加密与解密》</li>
<li>《计算机病毒防范艺术》</li>
<li>《病毒分析实战》</li>

<li><p>《黑客免杀攻防》</p></li>

<li><p>《集体智慧编程》</p></li>

<li><p>《模式分类》</p></li>
</ul>

<hr />

<h3 id="资料下载">资料下载</h3>

<p><a href="/stuff/2014/HowToWriteASimpleVirusScanner.key">演示文稿下载</a></p>

<hr />

<h3 id="个人总结">个人总结</h3>

<p>此次分享存在以下问题：</p>

<ul>
<li>时间估计不足。
前期由于对内容多少没有把握，且讲解的时间没有经验，估计了30分钟，但结果却超过了1个小时。</li>
<li>互动不足。
几乎没有互动环节，没有与听众进行互动。</li>
<li>内容侧重点不足。
前期铺垫知识过多，导致前期时间占用较多。最后的“机器学习实现”部分讲解时间不够充分。</li>
</ul>

<p>总体来说，相信这次分享加深了大家对病毒的了解。相信再有机会还会进行分享，为济南营造好的程序员氛围做出努力哈。</p>


    
</div>



	<p><small><em>Written December 7, 2014. </em>
		 
		Send feedback to <a  href="https://twitter.com/intent/tweet?text=%40everettjf%20%2320141207%25E5%25A6%2582%25E4%25BD%2595%25E7%25BC%2596%25E5%2586%2599%25E7%25AE%2580%25E6%2598%2593%25E7%2597%2585%25E6%25AF%2592%25E6%2589%25AB%25E6%258F%258F%25E7%25A8%258B%25E5%25BA%258F%20">@everettjf</a>.
		
    </small></p>

	<p>
	<a href="/2014/11/07/windows%E4%B8%8B%E5%AE%9E%E7%8E%B0%E9%BC%A0%E6%A0%87%E6%BB%9A%E8%BD%AE%E7%9A%84%E8%87%AA%E7%84%B6%E6%96%B9%E5%90%91%E6%BB%9A%E5%8A%A8/">← windows下实现鼠标滚轮的”自然方向滚动”</a>&nbsp;
	<a href="/2015/01/15/2014%E5%B9%B4%E6%80%BB%E7%BB%93%E5%8F%8A2015%E5%B9%B4%E8%AE%A1%E5%88%92/" style="float:right;">2014年总结及2015年计划 →</a>
	</p>



<section id="disqus_thread"></section>


<script type="text/javascript">
     
    var disqus_shortname = 'everettjf';

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

     
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



<footer>
	<hr/>
	<p>https://creativecommons.org/licenses/by-nc-sa/2.5/</p>
	<p>This site was made with <a href="https://github.com/gohugoio/hugo">Hugo</a> using theme <a href="https://github.com/schollz/onetwothree">onetwothree</a>.</p>
</footer>
</body>
</html>
