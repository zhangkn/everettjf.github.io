<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>YYWebImage note</title>
	
	<meta name="description" content="">
	<meta name="image" content="favicon.ico">
	
	<meta itemprop="name" content="YYWebImage note">
	<meta itemprop="description" content="">
	<meta itemprop="image" content="favicon.ico">
	
	<meta name="twitter:card" content="summary">
	<meta name="twitter:title" content="YYWebImage note">
	<meta name="twitter:description" content="">
	<meta name="twitter:site" content="@everettjf">
	<meta name="twitter:creator" content="@everettjf">
	<meta name="twitter:image:src" content="favicon.ico">
	
	
	<meta name="og:title" content="YYWebImage note">
	<meta name="og:description" content="">
	<meta name="og:image" content="http://everettjf.com/favicon.ico">
	<meta name="og:url" content="http://everettjf.com/2016/04/05/2016-04-05-learn-yywebimage/">
	<meta name="og:site_name" content="YYWebImage note">
	<meta name="og:type" content="article">
	
	<meta name="article:author" content="everettjf">
	<meta name="article:tag" content="">
	<link rel="stylesheet" type="text/css" href="/css/style.css">
	<script src="/js/caption.js"></script>

	<link rel="icon" href="/favicon.ico" type="image/x-icon">  
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">  

	
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111349332-1"></script>
	<script>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());

	gtag('config', 'UA-111349332-1');
	</script>

</head>

<body>

<header>
	<a href="/">/posts</a>
	
		
		&nbsp;&nbsp;·&nbsp;<a href="/about/" style="color:black;">/about</a>
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	


</header>


<div class="content">
    <h1>YYWebImage note <aside></aside></h1>

    <p>
    <nav id="TableOfContents">
<ul>
<li><a href="#basic-information">Basic Information</a></li>
<li><a href="#global-note">Global Note</a></li>
<li><a href="#file-notes">File Notes</a>
<ul>
<li><a href="#0-yyimagecache-m">0. YYImageCache.m</a></li>
<li><a href="#1-yywebimageoperation-m">1. YYWebImageOperation.m</a></li>
<li><a href="#2-yywebimageoperation-m">2. YYWebImageOperation.m</a></li>
<li><a href="#3-yywebimageoperation-m">3. YYWebImageOperation.m</a></li>
<li><a href="#4-yywebimageoperation-m">4. YYWebImageOperation.m</a></li>
<li><a href="#5-yywebimageoperation-m">5. YYWebImageOperation.m</a></li>
<li><a href="#6-yywebimageoperation-m">6. YYWebImageOperation.m</a></li>
<li><a href="#7-yywebimageoperation-m">7. YYWebImageOperation.m</a></li>
<li><a href="#8-yywebimageoperation-m">8. YYWebImageOperation.m</a></li>
<li><a href="#9-yywebimagemanager-m">9. YYWebImageManager.m</a></li>
<li><a href="#10-yyimage-m">10. YYImage.m</a></li>
<li><a href="#11-yyspritesheetimage-h">11. YYSpriteSheetImage.h</a></li>
<li><a href="#12-yyframeimage-h">12. YYFrameImage.h</a></li>
<li><a href="#13-yyimagecoder-m">13. YYImageCoder.m</a></li>
<li><a href="#14-uiimage-yywebimage-m">14. UIImage+YYWebImage.m</a></li>
<li><a href="#15-uiimageview-yywebimage-m">15. UIImageView+YYWebImage.m</a></li>
<li><a href="#16-yywebimagesetter-h">16. _YYWebImageSetter.h</a></li>
<li><a href="#17-yywebimagesetter-m">17. _YYWebImageSetter.m</a></li>
<li><a href="#18-yywebimagesetter-m">18. _YYWebImageSetter.m</a></li>
<li><a href="#19-uiimageview-yywebimage-m">19. UIImageView+YYWebImage.m</a></li>
<li><a href="#20-yywebimagesetter-m">20. _YYWebImageSetter.m</a></li>
</ul></li>
<li><a href="#summarize">Summarize</a></li>
</ul>
</nav>
    </p>

    <hr/>
    <p>&nbsp;</p>

    

<h1 id="basic-information">Basic Information</h1>

<ul>
<li>Name : YYWebImage</li>
<li>Site : <a href="https://github.com/ibireme/YYWebImage">https://github.com/ibireme/YYWebImage</a></li>
<li>Repo : <a href="https://github.com/ibireme/YYWebImage">https://github.com/ibireme/YYWebImage</a></li>
<li>Revision : c97ef715462aa8f94ecaa55564aa4514cc39ae89</li>
<li>Description :
YYKit 组件之一。新出炉的WebImage。</li>
</ul>

<h1 id="global-note">Global Note</h1>

<h1 id="file-notes">File Notes</h1>

<h2 id="0-yyimagecache-m">0. YYImageCache.m</h2>

<ul>
<li>Path : /YYWebImage/YYImageCache.m</li>
<li>Line : 47 - 55</li>
<li>Note :</li>
</ul>

<pre><code class="language-c">- (NSUInteger)imageCost:(UIImage *)image {
    CGImageRef cgImage = image.CGImage;
    if (!cgImage) return 1;
    CGFloat height = CGImageGetHeight(cgImage);
    size_t bytesPerRow = CGImageGetBytesPerRow(cgImage);
    NSUInteger cost = bytesPerRow * height;
    if (cost == 0) cost = 1;
    return cost;
}
</code></pre>

<p>CGImageGetHeight 和 CGImageGetBytesPerRow。</p>

<h2 id="1-yywebimageoperation-m">1. YYWebImageOperation.m</h2>

<ul>
<li>Path : /YYWebImage/YYWebImageOperation.m</li>
<li>Line : 27 - 41</li>
<li>Note :</li>
</ul>

<pre><code class="language-c">
/// Returns nil in App Extension.
static UIApplication *_YYSharedApplication() {
    static BOOL isAppExtension = NO;
    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{
        Class cls = NSClassFromString(@&quot;UIApplication&quot;);
        if(!cls || ![cls respondsToSelector:@selector(sharedApplication)]) isAppExtension = YES;
        if ([[[NSBundle mainBundle] bundlePath] hasSuffix:@&quot;.appex&quot;]) isAppExtension = YES;
    });
#pragma clang diagnostic push
#pragma clang diagnostic ignored &quot;-Wundeclared-selector&quot;
    return isAppExtension ? nil : [UIApplication performSelector:@selector(sharedApplication)];
#pragma clang diagnostic pop
}
</code></pre>

<p>appex : Share Extension 。 iOS8 新增功能。</p>

<h2 id="2-yywebimageoperation-m">2. YYWebImageOperation.m</h2>

<ul>
<li>Path : /YYWebImage/YYWebImageOperation.m</li>
<li>Line : 71 - 89</li>
<li>Note :</li>
</ul>

<pre><code class="language-c">static NSMutableSet *URLBlacklist;
static dispatch_semaphore_t URLBlacklistLock;

static void URLBlacklistInit() {
    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{
        URLBlacklist = [NSMutableSet new];
        URLBlacklistLock = dispatch_semaphore_create(1);
    });
}

static BOOL URLBlackListContains(NSURL *url) {
    if (!url || url == (id)[NSNull null]) return NO;
    URLBlacklistInit();
    dispatch_semaphore_wait(URLBlacklistLock, DISPATCH_TIME_FOREVER);
    BOOL contains = [URLBlacklist containsObject:url];
    dispatch_semaphore_signal(URLBlacklistLock);
    return contains;
}
</code></pre>

<p>dispatch_semaphore_xxx 系列。这里竟然用了静态变量。不过文件内有效，无所谓了。</p>

<h2 id="3-yywebimageoperation-m">3. YYWebImageOperation.m</h2>

<ul>
<li>Path : /YYWebImage/YYWebImageOperation.m</li>
<li>Line : 100 - 159</li>
<li>Note :</li>
</ul>

<pre><code class="language-c">/// A proxy used to hold a weak object.
@interface _YYWebImageWeakProxy : NSProxy
@property (nonatomic, weak, readonly) id target;
- (instancetype)initWithTarget:(id)target;
+ (instancetype)proxyWithTarget:(id)target;
@end

@implementation _YYWebImageWeakProxy
- (instancetype)initWithTarget:(id)target {
    _target = target;
    return self;
}
+ (instancetype)proxyWithTarget:(id)target {
    return [[_YYWebImageWeakProxy alloc] initWithTarget:target];
}
- (id)forwardingTargetForSelector:(SEL)selector {
    return _target;
}
- (void)forwardInvocation:(NSInvocation *)invocation {
    void *null = NULL;
    [invocation setReturnValue:&amp;null];
}
- (NSMethodSignature *)methodSignatureForSelector:(SEL)selector {
    return [NSObject instanceMethodSignatureForSelector:@selector(init)];
}
- (BOOL)respondsToSelector:(SEL)aSelector {
    return [_target respondsToSelector:aSelector];
}
- (BOOL)isEqual:(id)object {
    return [_target isEqual:object];
}
- (NSUInteger)hash {
    return [_target hash];
}
- (Class)superclass {
    return [_target superclass];
}
- (Class)class {
    return [_target class];
}
- (BOOL)isKindOfClass:(Class)aClass {
    return [_target isKindOfClass:aClass];
}
- (BOOL)isMemberOfClass:(Class)aClass {
    return [_target isMemberOfClass:aClass];
}
- (BOOL)conformsToProtocol:(Protocol *)aProtocol {
    return [_target conformsToProtocol:aProtocol];
}
- (BOOL)isProxy {
    return YES;
}
- (NSString *)description {
    return [_target description];
}
- (NSString *)debugDescription {
    return [_target debugDescription];
}
@end
</code></pre>

<p>NSProxy 协议，实现了NSObject协议</p>

<h2 id="4-yywebimageoperation-m">4. YYWebImageOperation.m</h2>

<ul>
<li>Path : /YYWebImage/YYWebImageOperation.m</li>
<li>Line : 190 - 198</li>
<li>Note :</li>
</ul>

<pre><code class="language-c">/// Network thread entry point.
+ (void)_networkThreadMain:(id)object {
    @autoreleasepool {
        [[NSThread currentThread] setName:@&quot;com.ibireme.webimage.request&quot;];
        NSRunLoop *runLoop = [NSRunLoop currentRunLoop];
        [runLoop addPort:[NSMachPort port] forMode:NSDefaultRunLoopMode];
        [runLoop run];
    }
}
</code></pre>

<p>网络线程。 给NSURLConnection使用的。</p>

<h2 id="5-yywebimageoperation-m">5. YYWebImageOperation.m</h2>

<ul>
<li>Path : /YYWebImage/YYWebImageOperation.m</li>
<li>Line : 214 - 240</li>
<li>Note :</li>
</ul>

<pre><code class="language-c">/// Global image queue, used for image reading and decoding.
+ (dispatch_queue_t)_imageQueue {
    #define MAX_QUEUE_COUNT 16
    static int queueCount;
    static dispatch_queue_t queues[MAX_QUEUE_COUNT];
    static dispatch_once_t onceToken;
    static int32_t counter = 0;
    dispatch_once(&amp;onceToken, ^{
        queueCount = (int)[NSProcessInfo processInfo].activeProcessorCount;
        queueCount = queueCount &lt; 1 ? 1 : queueCount &gt; MAX_QUEUE_COUNT ? MAX_QUEUE_COUNT : queueCount;
        if ([UIDevice currentDevice].systemVersion.floatValue &gt;= 8.0) {
            for (NSUInteger i = 0; i &lt; queueCount; i++) {
                dispatch_queue_attr_t attr = dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_SERIAL, QOS_CLASS_UTILITY, 0);
                queues[i] = dispatch_queue_create(&quot;com.ibireme.image.decode&quot;, attr);
            }
        } else {
            for (NSUInteger i = 0; i &lt; queueCount; i++) {
                queues[i] = dispatch_queue_create(&quot;com.ibireme.image.decode&quot;, DISPATCH_QUEUE_SERIAL);
                dispatch_set_target_queue(queues[i], dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_LOW, 0));
            }
        }
    });
    int32_t cur = OSAtomicIncrement32(&amp;counter);
    if (cur &lt; 0) cur = -cur;
    return queues[(cur) % queueCount];
    #undef MAX_QUEUE_COUNT
}
</code></pre>

<p>iOS 8 以下使用dispatch_set_target_queue设置优先级。</p>

<p>创建活跃处理器个数的队列。并逐个选取队列。</p>

<pre><code>int32_t cur = OSAtomicIncrement32(&amp;counter); 原子增。
</code></pre>

<h2 id="6-yywebimageoperation-m">6. YYWebImageOperation.m</h2>

<ul>
<li>Path : /YYWebImage/YYWebImageOperation.m</li>
<li>Line : 341 - 341</li>
<li>Note :</li>
</ul>

<pre><code class="language-c">                        [self performSelector:@selector(_startRequest:) onThread:[self.class _networkThread] withObject:nil waitUntilDone:NO];
</code></pre>

<p>在指定的线程上发起请求。</p>

<h2 id="7-yywebimageoperation-m">7. YYWebImageOperation.m</h2>

<ul>
<li>Path : /YYWebImage/YYWebImageOperation.m</li>
<li>Line : 366 - 371</li>
<li>Note :</li>
</ul>

<pre><code class="language-c">        if (_request.URL.isFileURL) {
            NSArray *keys = @[NSURLFileSizeKey];
            NSDictionary *attr = [_request.URL resourceValuesForKeys:keys error:nil];
            NSNumber *fileSize = attr[NSURLFileSizeKey];
            _expectedSize = fileSize ? fileSize.unsignedIntegerValue : -1;
        }
</code></pre>

<p>预估文件大小。</p>

<p>还可以这么判断file url？网络上的url如何判断呢？</p>

<h2 id="8-yywebimageoperation-m">8. YYWebImageOperation.m</h2>

<ul>
<li>Path : /YYWebImage/YYWebImageOperation.m</li>
<li>Line : 516 - 532</li>
<li>Note :</li>
</ul>

<pre><code class="language-c">- (void)connection:(NSURLConnection *)connection didReceiveData:(NSData *)data {
    @autoreleasepool {
        [_lock lock];
        BOOL canceled = [self isCancelled];
        [_lock unlock];
        if (canceled) return;
        
        if (data) [_data appendData:data];
        if (_progress) {
            [_lock lock];
            if (![self isCancelled]) {
                _progress(_data.length, _expectedSize);
            }
            [_lock unlock];
        }
        
        /*--------------------------- progressive ----------------------------*/
</code></pre>

<p>这里的progressive判断较多。实现还是比较精简。</p>

<h2 id="9-yywebimagemanager-m">9. YYWebImageManager.m</h2>

<ul>
<li>Path : /YYWebImage/YYWebImageManager.m</li>
<li>Line : 132 - 164</li>
<li>Note :</li>
</ul>

<pre><code class="language-c">+ (void)_delaySetActivity:(NSTimer *)timer {
    UIApplication *app = _YYSharedApplication();
    if (!app) return;
    
    NSNumber *visiable = timer.userInfo;
    if (app.networkActivityIndicatorVisible != visiable.boolValue) {
        [app setNetworkActivityIndicatorVisible:visiable.boolValue];
    }
    [timer invalidate];
}

+ (void)_changeNetworkActivityCount:(NSInteger)delta {
    if (!_YYSharedApplication()) return;
    
    void (^block)() = ^{
        _YYWebImageApplicationNetworkIndicatorInfo *info = [self _networkIndicatorInfo];
        if (!info) {
            info = [_YYWebImageApplicationNetworkIndicatorInfo new];
            [self _setNetworkIndicatorInfo:info];
        }
        NSInteger count = info.count;
        count += delta;
        info.count = count;
        [info.timer invalidate];
        info.timer = [NSTimer timerWithTimeInterval:kNetworkIndicatorDelay target:self selector:@selector(_delaySetActivity:) userInfo:@(info.count &gt; 0) repeats:NO];
        [[NSRunLoop mainRunLoop] addTimer:info.timer forMode:NSRunLoopCommonModes];
    };
    if ([NSThread isMainThread]) {
        block();
    } else {
        dispatch_async(dispatch_get_main_queue(), block);
    }
}
</code></pre>

<p>可控制是否显示网络活动的标记。status bar中的网络indicator 。</p>

<h2 id="10-yyimage-m">10. YYImage.m</h2>

<ul>
<li>Path : /YYWebImage/Image/YYImage.m</li>
<li>Line : 57 - 84</li>
<li>Note :</li>
</ul>

<pre><code class="language-c">/**
 Return the path scale.
 
 e.g.
 &lt;table&gt;
 &lt;tr&gt;&lt;th&gt;Path            &lt;/th&gt;&lt;th&gt;Scale &lt;/th&gt;&lt;/tr&gt;
 &lt;tr&gt;&lt;td&gt;&quot;icon.png&quot;      &lt;/td&gt;&lt;td&gt;1     &lt;/td&gt;&lt;/tr&gt;
 &lt;tr&gt;&lt;td&gt;&quot;icon@2x.png&quot;   &lt;/td&gt;&lt;td&gt;2     &lt;/td&gt;&lt;/tr&gt;
 &lt;tr&gt;&lt;td&gt;&quot;icon@2.5x.png&quot; &lt;/td&gt;&lt;td&gt;2.5   &lt;/td&gt;&lt;/tr&gt;
 &lt;tr&gt;&lt;td&gt;&quot;icon@2x&quot;       &lt;/td&gt;&lt;td&gt;1     &lt;/td&gt;&lt;/tr&gt;
 &lt;tr&gt;&lt;td&gt;&quot;icon@2x..png&quot;  &lt;/td&gt;&lt;td&gt;1     &lt;/td&gt;&lt;/tr&gt;
 &lt;tr&gt;&lt;td&gt;&quot;icon@2x.png/&quot;  &lt;/td&gt;&lt;td&gt;1     &lt;/td&gt;&lt;/tr&gt;
 &lt;/table&gt;
 */
static CGFloat _NSStringPathScale(NSString *string) {
    if (string.length == 0 || [string hasSuffix:@&quot;/&quot;]) return 1;
    NSString *name = string.stringByDeletingPathExtension;
    __block CGFloat scale = 1;
    
    NSRegularExpression *pattern = [NSRegularExpression regularExpressionWithPattern:@&quot;@[0-9]+\\.?[0-9]*x$&quot; options:NSRegularExpressionAnchorsMatchLines error:nil];
    [pattern enumerateMatchesInString:name options:kNilOptions range:NSMakeRange(0, name.length) usingBlock:^(NSTextCheckingResult *result, NSMatchingFlags flags, BOOL *stop) {
        if (result.range.location &gt;= 3) {
            scale = [string substringWithRange:NSMakeRange(result.range.location + 1, result.range.length - 2)].doubleValue;
        }
    }];
    
    return scale;
}
</code></pre>

<p>从文件名获取scale</p>

<h2 id="11-yyspritesheetimage-h">11. YYSpriteSheetImage.h</h2>

<ul>
<li>Path : /YYWebImage/Image/YYSpriteSheetImage.h</li>
<li>Line : 66 - 66</li>
<li>Note :</li>
</ul>

<pre><code class="language-c">@interface YYSpriteSheetImage : UIImage &lt;YYAnimatedImage&gt;
</code></pre>

<p>播放精灵动画，不错。</p>

<h2 id="12-yyframeimage-h">12. YYFrameImage.h</h2>

<ul>
<li>Path : /YYWebImage/Image/YYFrameImage.h</li>
<li>Line : 39 - 39</li>
<li>Note :</li>
</ul>

<pre><code class="language-c">@interface YYFrameImage : UIImage &lt;YYAnimatedImage&gt;
</code></pre>

<p>序列帧动画</p>

<h2 id="13-yyimagecoder-m">13. YYImageCoder.m</h2>

<ul>
<li>Path : /YYWebImage/Image/YYImageCoder.m</li>
<li>Line : 1 - 1</li>
<li>Note :</li>
</ul>

<pre><code class="language-c">//
</code></pre>

<p>这个文件2k多行代码……细啊</p>

<h2 id="14-uiimage-yywebimage-m">14. UIImage+YYWebImage.m</h2>

<ul>
<li>Path : /YYWebImage/Categories/UIImage+YYWebImage.m</li>
<li>Line : 243 - 254</li>
<li>Note :</li>
</ul>

<pre><code class="language-c">
+ (UIImage *)yy_imageWithColor:(UIColor *)color size:(CGSize)size {
    if (!color || size.width &lt;= 0 || size.height &lt;= 0) return nil;
    CGRect rect = CGRectMake(0.0f, 0.0f, size.width, size.height);
    UIGraphicsBeginImageContextWithOptions(rect.size, NO, 0);
    CGContextRef context = UIGraphicsGetCurrentContext();
    CGContextSetFillColorWithColor(context, color.CGColor);
    CGContextFillRect(context, rect);
    UIImage *image = UIGraphicsGetImageFromCurrentImageContext();
    UIGraphicsEndImageContext();
    return image;
}
</code></pre>

<p>获取一个纯色的图片</p>

<h2 id="15-uiimageview-yywebimage-m">15. UIImageView+YYWebImage.m</h2>

<ul>
<li>Path : /YYWebImage/Categories/UIImageView+YYWebImage.m</li>
<li>Line : 102 - 107</li>
<li>Note :</li>
</ul>

<pre><code class="language-c">    _YYWebImageSetter *setter = objc_getAssociatedObject(self, &amp;_YYWebImageSetterKey);
    if (!setter) {
        setter = [_YYWebImageSetter new];
        objc_setAssociatedObject(self, &amp;_YYWebImageSetterKey, setter, OBJC_ASSOCIATION_RETAIN_NONATOMIC);
    }
    int32_t sentinel = [setter cancelWithNewURL:imageURL];
</code></pre>

<p>这个setter写法不错。先取消当前ImageView正在执行的operation。</p>

<h2 id="16-yywebimagesetter-h">16. _YYWebImageSetter.h</h2>

<ul>
<li>Path : /YYWebImage/Categories/_YYWebImageSetter.h</li>
<li>Line : 25 - 31</li>
<li>Note :</li>
</ul>

<pre><code class="language-c">static inline void _yy_dispatch_sync_on_main_queue(void (^block)()) {
    if (pthread_main_np()) {
        block();
    } else {
        dispatch_sync(dispatch_get_main_queue(), block);
    }
}
</code></pre>

<p>确保主线程sync</p>

<h2 id="17-yywebimagesetter-m">17. _YYWebImageSetter.m</h2>

<ul>
<li>Path : /YYWebImage/Categories/_YYWebImageSetter.m</li>
<li>Line : 80 - 91</li>
<li>Note :</li>
</ul>

<pre><code class="language-c">- (int32_t)cancelWithNewURL:(NSURL *)imageURL {
    int32_t sentinel;
    dispatch_semaphore_wait(_lock, DISPATCH_TIME_FOREVER);
    if (_operation) {
        [_operation cancel];
        _operation = nil;
    }
    _imageURL = imageURL;
    sentinel = OSAtomicIncrement32(&amp;_sentinel);
    dispatch_semaphore_signal(_lock);
    return sentinel;
}
</code></pre>

<p>返回一个哨兵数字</p>

<h2 id="18-yywebimagesetter-m">18. _YYWebImageSetter.m</h2>

<ul>
<li>Path : /YYWebImage/Categories/_YYWebImageSetter.m</li>
<li>Line : 64 - 73</li>
<li>Note :</li>
</ul>

<pre><code class="language-c">    dispatch_semaphore_wait(_lock, DISPATCH_TIME_FOREVER);
    if (sentinel == _sentinel) {
        if (_operation) [_operation cancel];
        _operation = operation;
        sentinel = OSAtomicIncrement32(&amp;_sentinel);
    } else {
        [operation cancel];
    }
    dispatch_semaphore_signal(_lock);
    return sentinel;
</code></pre>

<p>判断哨兵数字是否变化</p>

<h2 id="19-uiimageview-yywebimage-m">19. UIImageView+YYWebImage.m</h2>

<ul>
<li>Path : /YYWebImage/Categories/UIImageView+YYWebImage.m</li>
<li>Line : 180 - 180</li>
<li>Note :</li>
</ul>

<pre><code class="language-c">            newSentinel = [setter setOperationWithSentinel:sentinel url:imageURL options:options manager:manager progress:_progress transform:transform completion:_completion];
</code></pre>

<p>把sentinel传入。表示当前操作。</p>

<h2 id="20-yywebimagesetter-m">20. _YYWebImageSetter.m</h2>

<ul>
<li>Path : /YYWebImage/Categories/_YYWebImageSetter.m</li>
<li>Line : 46 - 56</li>
<li>Note :</li>
</ul>

<pre><code class="language-c">- (int32_t)setOperationWithSentinel:(int32_t)sentinel
                                url:(NSURL *)imageURL
                            options:(YYWebImageOptions)options
                            manager:(YYWebImageManager *)manager
                           progress:(YYWebImageProgressBlock)progress
                          transform:(YYWebImageTransformBlock)transform
                         completion:(YYWebImageCompletionBlock)completion {
    if (sentinel != _sentinel) {
        if (completion) completion(nil, imageURL, YYWebImageFromNone, YYWebImageStageCancelled, nil);
        return _sentinel;
    }
</code></pre>

<p>如果传入的哨兵不是之前的哨兵，则说明重复调用了。</p>

<h1 id="summarize">Summarize</h1>

<hr />

<p><em>Generated by <a href="https://github.com/everettjf/XSourceNote">XSourceNote</a> at 2016-04-04 16:06:27 +0000</em></p>


    
</div>



	<p><small><em>Written April 5, 2016. </em>
		 
		Send feedback to <a  href="https://twitter.com/intent/tweet?text=%40everettjf%20%23201604052016-04-05-learn-yywebimage%20">@everettjf</a>.
		
    </small></p>

	<p>
	<a href="/2016/04/03/2016-04-03-learn-sdwebimage/">← SDWebImage note</a>&nbsp;
	<a href="/2016/04/09/2016-04-09-tabbar-delay-touches-began-problem/" style="float:right;">TabBar位置的二级页面touchesBegan被延迟调用 →</a>
	</p>



<section id="disqus_thread"></section>


<script type="text/javascript">
     
    var disqus_shortname = 'everettjf';

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

     
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



<footer>
	<hr/>
	<p>https://creativecommons.org/licenses/by-nc-sa/2.5/</p>
	<p>This site was made with <a href="https://github.com/gohugoio/hugo">Hugo</a> using theme <a href="https://github.com/schollz/onetwothree">onetwothree</a>.</p>
</footer>
</body>
</html>
