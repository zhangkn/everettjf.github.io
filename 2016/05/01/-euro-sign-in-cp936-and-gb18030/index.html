<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>€ euro sign in cp936 and gb18030</title>
	
	<meta name="description" content="">
	<meta name="image" content="favicon.ico">
	
	<meta itemprop="name" content="€ euro sign in cp936 and gb18030">
	<meta itemprop="description" content="">
	<meta itemprop="image" content="favicon.ico">
	
	<meta name="twitter:card" content="summary">
	<meta name="twitter:title" content="€ euro sign in cp936 and gb18030">
	<meta name="twitter:description" content="">
	<meta name="twitter:site" content="@everettjf">
	<meta name="twitter:creator" content="@everettjf">
	<meta name="twitter:image:src" content="favicon.ico">
	
	
	<meta name="og:title" content="€ euro sign in cp936 and gb18030">
	<meta name="og:description" content="">
	<meta name="og:image" content="http://everettjf.com/favicon.ico">
	<meta name="og:url" content="http://everettjf.com/2016/05/01/-euro-sign-in-cp936-and-gb18030/">
	<meta name="og:site_name" content="€ euro sign in cp936 and gb18030">
	<meta name="og:type" content="article">
	
	<meta name="article:author" content="everettjf">
	<meta name="article:tag" content="">
	<link rel="stylesheet" type="text/css" href="/css/style.css">
	<script src="/js/caption.js"></script>

	<link rel="icon" href="/favicon.ico" type="image/x-icon">  
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">  

	
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111349332-1"></script>
	<script>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());

	gtag('config', 'UA-111349332-1');
	</script>

</head>

<body>

<header>
	<a href="/">/posts</a>
	
		
		&nbsp;&nbsp;·&nbsp;<a href="/about/" style="color:black;">/about</a>
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	


</header>


<div id="loadingMask" style="width: 100%; height: 100%; position: fixed; background: #fff;"></div>
<script>
function fadeOut(el) {
  el.style.opacity = 1;

  var last = +new Date();
  var tick = function() {
    el.style.opacity = +el.style.opacity - (new Date() - last) / 80;
    last = +new Date();
    

    if (el.style.opacity > 0) {
      (window.requestAnimationFrame && requestAnimationFrame(tick)) || setTimeout(tick, 16);
    } else {
    	el.style.display='none';
    }
  };

  tick();
}

function ready(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
         el = document.getElementById('loadingMask');
         fadeOut(el);
        var elements = document.querySelectorAll("img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("alt")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("alt"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });

    } else {
        document.addEventListener('DOMContentLoaded', fn);
    }
}
window.onload = ready;
</script>

<div class="content">
    <h1>€ euro sign in cp936 and gb18030 <aside></aside></h1>

    <p>
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#第一层原因">第一层原因</a></li>
<li><a href="#第二层原因">第二层原因</a></li>
<li><a href="#第三层原因">第三层原因</a></li>
<li><a href="#解决办法">解决办法</a></li>
</ul></li>
<li><a href="#总结">总结</a></li>
</ul>
</nav>
    </p>

    <hr/>
    <p>&nbsp;</p>

    

<p>产品第一次AppStore审核通过，过年时遇到一个“神奇”的bug，在显示某些特殊字符时App会崩溃。后来经过各种尝试找到原因。</p>

<h2 id="第一层原因">第一层原因</h2>

<p>一个函数返回的NSString为nil，使用者没有判断nil，导致崩溃。</p>

<h2 id="第二层原因">第二层原因</h2>

<ul>
<li>部分业务数据库中的信息不是utf-8，而是PC客户端存入的cp936（数据库是SQL Server）</li>
<li>部分信息iOS拿到的是cp936编码的文字。</li>
<li>文字中包含欧元符号 € 。（<a href="https://en.wikipedia.org/wiki/Euro）">https://en.wikipedia.org/wiki/Euro）</a></li>
<li>iOS把cp936当做gb18030解码（主要是受gbk转utf-8影响，网上一把这类文章）</li>
<li>cp936中如果有欧元符号，则会返回nil。</li>
</ul>

<h2 id="第三层原因">第三层原因</h2>

<p>Windows的CP936并符合标准的GBK定义。</p>

<blockquote>
<p>Windows中CP936代码页使用0x80来表示欧元符号，而在GB18030编码中没有使用0x80编码位</p>

<p>Code page 936 is not identical to GBK because a code page encodes characters while the GBK only defines code points. In addition, the Euro sign (€), encoded as 0x80 in CP936, is not defined in GBK.</p>

<p>Windows CP936 code page 0x80 to represent the euro symbol in the GB18030 encoding 0x80 encoding, with other locations to represent the euro symbol. This can be understood to be a little problem on the GB18030 backward compatibility; also be understood as 0x80 CP936 expansion of GBK, GB18030 is only compatible and GBK.</p>
</blockquote>

<p>search 0x80 in <a href="https://en.wikipedia.org/wiki/Code_page_936">https://en.wikipedia.org/wiki/Code_page_936</a></p>

<p><a href="http://www.databasesql.info/article/8106207727/">http://www.databasesql.info/article/8106207727/</a></p>

<blockquote>
<p>Microsoft later added the euro sign to Codepage 936 and assigned the code 0x80 to it. This is not a valid code point in GBK 1.0.</p>
</blockquote>

<p><a href="https://en.wikipedia.org/wiki/GBK">https://en.wikipedia.org/wiki/GBK</a></p>

<p><a href="https://msdn.microsoft.com/zh-cn/goglobal/cc305153">https://msdn.microsoft.com/zh-cn/goglobal/cc305153</a></p>

<p><a href="https://msdn.microsoft.com/zh-cn/goglobal/bb688113.aspx">https://msdn.microsoft.com/zh-cn/goglobal/bb688113.aspx</a></p>

<h2 id="解决办法">解决办法</h2>

<p>并没有找到一个靠谱的编码转换工具（iconv貌似可以，但据同事说比较麻烦、且坑较多，使用的话未知风险太多）</p>

<p>手动替换0x80。</p>

<p>关键代码如下：</p>

<pre><code class="language-c">@implementation NSString(EncodingUtil)

+(NSString *)stringFromGBK:(const char *)srcString{
    // fix Windows CP936 0x80 extension for standard GBK
    
    const int x80 = 0x80;
    const char * toBeConvert = srcString;
    
    size_t x80count = 0;
    const size_t length = strlen(srcString);
    for(size_t idx = 0; idx &lt; length; ++idx){
        int code = (int)(unsigned char)srcString[idx];
        if(code == x80){
            ++x80count;
        }
    }
    
    char *newString = NULL;
    if(x80count &gt; 0){
        size_t newLength = length + x80count * sizeof(char);
        newString = (char*)malloc(newLength + 1);
        memset(newString,0,newLength + 1);
        
        BOOL ignoreNext = NO;
        size_t newPos = 0;
        for(size_t idx = 0; idx &lt; length; ++idx){
            int code = (int)(unsigned char)srcString[idx];
            if(ignoreNext){
                ignoreNext = NO;
                newString[newPos++] = srcString[idx];
                continue;
            }
            
            if(code &gt; x80)
                ignoreNext = YES;
            
            if(code == x80){
                newString[newPos++] = 0xa2;
                newString[newPos++] = 0xe3;
            }else{
                newString[newPos++] = srcString[idx];
            }
        }
        toBeConvert = newString;
    }
    
    NSStringEncoding enc = CFStringConvertEncodingToNSStringEncoding(kCFStringEncodingGB_18030_2000);
    NSString *retString = [[NSString alloc]initWithCString:toBeConvert encoding:enc];
    
    if(newString){
        free(newString);
    }
    
    return retString;
}
@end

</code></pre>

<p>测试代码：</p>

<pre><code class="language-c">char szBadName[101];
        memset(szBadName, 0, sizeof(szBadName));
        int pos = 0;
        szBadName[pos++] = '\xa8';
        szBadName[pos++] = 't';
        szBadName[pos++] = '\xa1';
        szBadName[pos++] = '\xfa';
        szBadName[pos++] = '\x8c';
        szBadName[pos++] = '\xa9';
        szBadName[pos++] = '\x92';
        szBadName[pos++] = '\xf6';
        szBadName[pos++] = '\xa2';
        szBadName[pos++] = '\xd9';
        szBadName[pos++] = '\x8b';
        szBadName[pos++] = '^';
        szBadName[pos++] = '\xc6';
        szBadName[pos++] = 'S';
        szBadName[pos++] = '\xbe';
        szBadName[pos++] = '\x80';
        szBadName[pos++] = '\xa8';
        szBadName[pos++] = '\xcb';
        
        szBadName[pos++] = '\x80';
        szBadName[pos++] = '\x80';
        szBadName[pos++] = '\xbe';
        szBadName[pos++] = '\x80';
        
        
        szBadName[pos++] = '7';
        szBadName[pos++] = '\xa8';
        szBadName[pos++] = '\x80';
        szBadName[pos++] = '\xa8';
        szBadName[pos++] = '\x80';
        szBadName[pos++] = '\xa8';
        szBadName[pos++] = '\x80';
        szBadName[pos++] = '6';
        szBadName[pos++] = '1';
        
        NSLog(@&quot;bad = %@&quot;,[NSString stringFromGBK:szBadName]);

</code></pre>

<h1 id="总结">总结</h1>

<p>这个问题不是普遍问题，应该99.99%的App不会遇到。可是我遇到了……</p>

<p>That&rsquo;s all.</p>


    
</div>



	<p><small><em>Written May 1, 2016. </em>
		 
		Send feedback to <a  href="https://twitter.com/intent/tweet?text=%40everettjf%20%2320160501-euro-sign-in-cp936-and-gb18030%20">@everettjf</a>.
		
    </small></p>

	<p>
	<a href="/2016/04/22/%E4%BC%81%E4%B8%9A%E8%AF%81%E4%B9%A6%E7%AD%BE%E5%90%8D%E7%9A%84app%E5%90%AF%E5%8A%A8%E6%85%A2%E5%81%9C%E5%9C%A8%E6%9A%97%E8%89%B2%E5%9B%BE%E6%A0%87n%E7%A7%92/">← 企业证书签名的App启动慢（停在暗色图标N秒）</a>&nbsp;
	<a href="/2016/05/10/symbolicatecrash-deadloop-bug/" style="float:right;">symbolicatecrash deadloop bug →</a>
	</p>



<section id="disqus_thread"></section>


<script type="text/javascript">
     
    var disqus_shortname = 'everettjf';

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

     
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



<footer>
	<hr/>
	<p>https://creativecommons.org/licenses/by-nc-sa/2.5/</p>
	<p>This site was made with <a href="https://github.com/gohugoio/hugo">Hugo</a> using theme <a href="https://github.com/schollz/onetwothree">onetwothree</a>.</p>
</footer>
</body>
</html>
